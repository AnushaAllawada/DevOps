<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="header bg-white shadow-sm p-4 flex items-center justify-between">
        <a href="/profile/" class="text-blue-600 hover:text-blue-800" aria-label="Go to Profile">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
        </a>
        <h1 class="text-xl font-semibold text-gray-800">Home</h1>
        <a href="/create-post/" class="text-blue-600 hover:text-blue-800" aria-label="Create Post">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
        </a>
    </header>
    <div class="container max-w-md mx-auto px-4 py-6">
        <div id="loading" class="flex justify-center items-center py-4 hidden">
            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
        </div>
        <div id="posts-list" class="space-y-4" role="list" aria-label="List of posts"></div>
        <div id="error-message" class="text-red-600 text-center mt-4 hidden" role="alert">
            Failed to load posts. <span id="error-details"></span>
            <button id="retry-button" class="ml-2 text-blue-600 hover:text-blue-800 underline" aria-label="Retry loading posts">Retry</button>
        </div>
    </div>

    <script>
        async function fetchWithAuth(url, options = {}) {
            let token = localStorage.getItem('access_token');
            if (!token) {
                console.error('No access token found, redirecting to login');
                window.location.href = '/';
                return null;
            }

            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            let response = await fetch(url, options);

            if (response.status === 401) {
                console.warn('401 Unauthorized, attempting token refresh');
                const refresh = localStorage.getItem('refresh_token');
                if (refresh) {
                    const refreshResponse = await fetch('/api/token/refresh/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refresh }),
                    });
                    if (refreshResponse.ok) {
                        const data = await refreshResponse.json();
                        localStorage.setItem('access_token', data.access);
                        console.log('Token refreshed successfully');
                        options.headers['Authorization'] = `Bearer ${data.access}`;
                        response = await fetch(url, options);
                    } else {
                        console.error('Token refresh failed:', refreshResponse.status);
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('refresh_token');
                        window.location.href = '/';
                        return null;
                    }
                } else {
                    console.error('No refresh token, redirecting to login');
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    window.location.href = '/';
                    return null;
                }
            }
            return response;
        }

        async function loadPosts() {
            const loading = document.getElementById('loading');
            const postsList = document.getElementById('posts-list');
            const errorMessage = document.getElementById('error-message');
            const errorDetails = document.getElementById('error-details');

            loading.classList.remove('hidden');
            postsList.classList.add('hidden');
            errorMessage.classList.add('hidden');

            try {
                const response = await fetchWithAuth('/api/posts/?view_type=following');
                if (!response) return;

                loading.classList.add('hidden');
                postsList.classList.remove('hidden');

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data); // Log for debugging

                if (!data.results || !Array.isArray(data.results)) {
                    throw new Error('Invalid data format: results is not an array');
                }

                if (data.results.length === 0) {
                    postsList.innerHTML = '<div class="p-4 bg-white rounded-lg text-gray-600 text-center">No posts to display.</div>';
                    return;
                }

                postsList.innerHTML = '';
                data.results.forEach(post => {
                    if (!post.author || !post.author.username) {
                        console.warn('Skipping post with invalid author:', post);
                        return;
                    }
                    const div = document.createElement('div');
                    div.className = 'bg-white rounded-lg shadow-sm p-4';
                    div.setAttribute('role', 'listitem');
                    const imageHtml = post.image ? `<img src="${post.image}" class="w-full rounded-lg mb-2 object-cover" alt="Post image" onerror="this.src='/media/post_images/placeholder.png'">` : '';
                    const likeIcon = post.is_liked ? 'text-red-500' : 'text-gray-500';
                    const profilePic = post.author.profile_picture || '/media/profile_pics/default-avatar.png';
                    div.innerHTML = `
                        <div class="flex items-center space-x-3 mb-2">
                            <img src="${profilePic}" class="w-10 h-10 rounded-full object-cover" alt="Profile picture of ${post.author.username}" onerror="this.src='/media/profile_pics/default-avatar.png'">
                            <a href="/users/${post.author.username}/" class="text-gray-800 font-medium hover:text-blue-600">${post.author.username}</a>
                        </div>
                        ${imageHtml}
                        <p class="text-gray-700 mb-2">${post.content || ''}</p>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span>${post.likes_count || 0} likes</span>
                            <a href="/posts/${post.id}/" class="hover:text-blue-600">${post.comments_count || 0} comments</a>
                        </div>
                        <div class="flex space-x-4 mt-2">
                            <button class="like-btn ${likeIcon} hover:text-red-600" data-post-id="${post.id}" aria-label="${post.is_liked ? 'Unlike' : 'Like'} post">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </button>
                            <a href="/posts/${post.id}/" class="text-gray-500 hover:text-blue-600" aria-label="Comment on post">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                            </a>
                        </div>
                    `;
                    postsList.appendChild(div);
                });

                document.querySelectorAll('.like-btn').forEach(button => {
                    button.addEventListener('click', async () => {
                        const postId = button.getAttribute('data-post-id');
                        await toggleLike(postId, button);
                    });
                });

            } catch (error) {
                console.error('Error loading posts:', error);
                loading.classList.add('hidden');
                postsList.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorDetails.textContent = error.message;
            }
        }

        async function toggleLike(postId, button) {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetchWithAuth(`/api/posts/${postId}/like/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                if (!response) return;

                if (response.ok) {
                    const data = await response.json();
                    const postDiv = button.closest('div[role="listitem"]');
                    postDiv.querySelector('span').textContent = `${data.likes_count} likes`;
                    button.className = `like-btn ${data.is_liked ? 'text-red-500' : 'text-gray-500'} hover:text-red-600`;
                    button.setAttribute('aria-label', data.is_liked ? 'Unlike post' : 'Like post');
                } else {
                    document.getElementById('error-message').classList.remove('hidden');
                    document.getElementById('error-details').textContent = `Like failed: ${response.status}`;
                }
            } catch (error) {
                console.error('Error toggling like:', error);
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('error-details').textContent = error.message;
            }
        }

        function addRetryListener() {
            const retryButton = document.getElementById('retry-button');
            if (retryButton) {
                retryButton.addEventListener('click', () => {
                    loadPosts();
                });
            }
        }

        loadPosts();
    </script>
</body>
</html>